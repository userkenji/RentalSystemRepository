<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja" data-bs-theme="auto">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<link rel="icon" type="image/svg+xml" href="/img/favicon.png">
	<title>商品登録・編集 - 管理者ページ</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/normal.css" rel="stylesheet">
</head>

<body>
	<header data-bs-theme="dark">
		<div class="navbar navbar-dark bg-warning shadow-sm">
			<div class="container">
				<a href="/admin" class="navbar-brand d-flex align-items-center">
					<img src="/img/icon_white.png" alt="カメラのアイコン" style="width: 25px; margin-right: 5px;">
					<strong>管理者ページ - 商品<span th:text="${product.id != null} ? '編集' : '登録'">登録</span></strong>
				</a>
				<div class="d-flex">
					<a href="/admin/product-list" class="btn btn-outline-dark btn-sm me-2">商品一覧へ</a>
					<form th:action="@{/admin/logout}" method="post" class="d-inline">
						<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
				        <button type="submit" class="btn btn-outline-dark btn-sm">
				            ログアウト
				        </button>
				    </form>
				</div>
			</div>
		</div>
	</header>

	<main>
		<section class="py-4 container">
			<div class="row justify-content-center">
				<div class="col-lg-8">
					<h2 class="fw-light mb-4">
						<span th:if="${product.id == null}">新規商品登録</span>
					</h2>

					<!-- エラーメッセージ -->
					<div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
						<span th:text="${error}"></span>
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>

					<!-- 成功メッセージ -->
					<div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
						<span th:text="${success}"></span>
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>

					<div class="card">
						<div class="card-body">
							<form method="post" th:action="@{/admin/product-save}" enctype="multipart/form-data" th:object="${product}">
								
								<!-- 商品ID (編集時のみ) -->
								<input type="hidden" th:field="*{id}" th:if="${product.id != null}">

								<!-- 商品名 -->
								<div class="mb-3">
									<label for="title" class="form-label">商品名 <span class="text-danger">*</span></label>
									<input type="text" class="form-control" id="title" th:field="*{title}" required>
									<div class="form-text">商品の正式名称を入力してください</div>
								</div>

								<!-- 商品画像 -->
								<div class="mb-3">
								  <label for="imageFile" class="form-label">商品画像</label>
								  
								  <input type="file" id="imageFile" name="imageFile" class="form-control" accept="image/*">
								  <input type="hidden" id="imageFileName" name="imageFileName">
									<!-- 選択時にファイル名を取得 -->
									<script>
									  document.getElementById("imageFile").addEventListener("change", (e) => {
									    const f = e.target.files[0];
									    if (!f) return;
									    document.getElementById("imageFileName").value = f.name;
									  });
									</script>
									
								  <div class="form-text">JPG, PNG形式の画像をアップロードしてください (最大5MB)</div>
								
								  <!-- プレビュー領域（新規でも編集でも共通で使う） -->
								  <div class="mt-3">
								    <p class="text-muted mb-2" id="previewLabel"
								       th:text="${product.imageFileName != null} ? '現在の画像:' : 'プレビュー:'">
								      プレビュー:
								    </p>
								
								    <!-- 編集時：DBに入ってる画像を最初に表示 -->
								    <img id="imagePreview"
								         th:if="${product.imageFileName != null}"
								         th:src="@{/img/{file}(file=${product.imageFileName})}"
								         th:alt="${product.title}"
								         class="img-thumbnail"
								         style="max-width:200px; display:block;">
								
								    <!-- 新規時：最初は非表示（画像選択で表示される） -->
								    <img id="imagePreviewEmpty"
								     alt="画像"
								     class="img-thumbnail"
								     style="max-width:200px; display:none;">
								         
								         
								    
								  </div>
								  

								
								  
								</div>
								
								<script>
								  // 画像選択したらその場でプレビュー表示
								  document.addEventListener("DOMContentLoaded", () => {
								    const input = document.getElementById("imageFile");
								    const preview = document.getElementById("imagePreview") || document.getElementById("imagePreviewEmpty");
								    const label = document.getElementById("previewLabel");
								
								    if (!input || !preview) return;
								
								    input.addEventListener("change", () => {
								      const file = input.files && input.files[0];
								      if (!file) return;
								
								      preview.src = URL.createObjectURL(file);
								      preview.style.display = "block";
								      if (label) label.textContent = "プレビュー:";
								    });
								  });
								</script>



								<!-- 商品説明 -->
								<div class="mb-3">
									<label for="description" class="form-label">商品説明 <span class="text-danger">*</span></label>
									<textarea class="form-control" id="description" th:field="*{description}" rows="5" required></textarea>
									<div class="form-text">商品の特徴、仕様などを詳しく記載してください</div>
								</div>

								

								<!-- 店内在庫数 -->
								<div class="mb-3">
									<label for="stock" class="form-label">店内在庫数 <span class="text-danger">*</span></label>
									<input type="number" class="form-control" id="stock" th:field="*{notRentedStock}" min="0" required>
								</div>
								
								<!-- 貸出在庫数 -->
								<div class="mb-3">
									<label for="stock" class="form-label">貸出在庫数 <span class="text-danger">*</span></label>
									<input type="number" class="form-control" id="stock" th:field="*{rentedStock}" min="0" required>
								</div>
								
								<!-- 在庫数 -->
								<div class="mb-3">
									<label for="stock" class="form-label">在庫数(店内在庫＋貸出在庫) <span class="text-danger">*</span></label>
									<input type="number" class="form-control" id="stock" th:field="*{stock}" min="0" required>
								</div>


								

								<!-- 送信ボタン -->
								<div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
									<a th:href="@{/admin/products}" class="btn btn-secondary me-md-2">キャンセル</a>
									<button type="submit" class="btn btn-primary">
										<span th:text="${product.id == null} ? '登録する' : '更新する'">登録する</span>
									</button>
								</div>

							</form>
						</div>
					</div>

				</div>
			</div>
		</section>

	</main>

	<footer class="text-body-secondary py-5">
		<div class="container">
			<p class="float-end mb-1">
				<a href="#">Back to top</a>
			</p>
			<p class="mb-1">&copy; 株式会社 Music Life Agency</p>
		</div>
	</footer>
	<script src="/js/bootstrap.bundle.min.js"></script>

</body>

</html>